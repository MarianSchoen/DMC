---
title: "report"
output: pdf_document
params:
   tempdir: ""
   metric: "cor"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
temp.dir <- params$tempdir
benchmark.name <- strsplit(temp.dir, "/")[[1]][length(strsplit(temp.dir, "/")[[1]])]
# read input and processed data
input_raw <- read_data(paste(temp.dir, "/input_data/raw.h5", sep=""))
sc.counts <- input_raw$sc.counts
sc.pheno <- input_raw$sc.pheno
real.counts <- input_raw$bulk.counts
real.props <- input_raw$bulk.props
validation_set <- read_data(paste(temp.dir, "/input_data/validation_set.h5", sep = ""))
training_set <- read_data(paste(temp.dir, "/input_data/training_set.h5", sep=""))
training.exprs <- training_set$sc.counts
training.pheno <- training_set$sc.pheno
test.exprs <- validation_set$sc.counts
test.pheno <- validation_set$sc.pheno
sim.bulks <- list(bulks = validation_set$real.counts, props = validation_set$real.props)
# load input parameters
input_params <- read_misc_input(paste(temp.dir, "input_data/params.h5", sep = "/"))
genesets <- input_params$genesets
algorithm.names <- input_params$algorithms
function.call <- input_params$function.call
grouping <- input_params$grouping
```

## Deconvolution Benchmark

### Input data

```{r}
print(function.call)
``` 

Single-cell data contained `r nrow(sc.counts)` features for `r ncol(sc.counts)` cells.  


Corresponding phenotype data contained labels for `r length(unique(sc.pheno$cell_type))` cell types: `r unique(sc.pheno$cell_type)`  


Used algorithms: `r algorithm.names`   


`r ncol(real.counts)` real bulk profiles were available.  


Common features: `r length(intersect(rownames(real.counts), rownames(sc.counts)))`.  

Ground-truth cell type quantities were available for `r nrow(real.props)` cell types.  



```{r real_props, echo = FALSE}
print(real.props)
```
\pagebreak
## Deconvolution of real bulks

```{r real_results, echo=FALSE}
files <- list.files(paste(temp.dir, "/results/real", sep = ""), full.names = T, pattern = "*.h5")
results.lists <- list()
for(i in 1:length(files)) {
  results.lists[[i]] <- read_result_list(files[i])
}

for(i in 1:length(results.lists)){
	temp.df <- prepare_data(results.lists[[i]], params$metric)
	if(!is.null(temp.df)){
		if(!exists("real.df")){
			real.df <- temp.df
		}else{
			real.df <- rbind(real.df, temp.df)
 		}
	}
}

score.plot <- evaluation_plot(real.df, "deconvolution quality",params$metric)
runtime.plot <- plot_runtime(real.df)
scatter.plots.list <- list()
for(i in 1:length(results.lists)) {
	scatter.plots.list[[i]] <- create_scatterplots(results.lists[[i]])
}
cond.num.plots <- plot_cond_num(real.df, metric = params$metric)
score.width <- 2 * length(unique(real.df$cell_type))
score.height <- 2 * length(algorithm.names)
```
```{r score_plot, echo = FALSE, fig.width = score.width, fig.height = score.height}
plot(score.plot)
```
\pagebreak  


```{r runtime_plot, echo = FALSE, fig.width = 16, fig.height = 9}
plot(runtime.plot)
```
\pagebreak  


```{r scatter_plots, echo = FALSE, fig.width = 18, fig.height = 5}
for(l in scatter.plots.list){
	for(p in l) {
		plot(p)
	}
}
```

\pagebreak
```{r condition_plots, fig.width = 16, fig.height = 9}
plot(cond.num.plots$cond_num_plot)
plot(cond.num.plots$cond_vs_score)
plot(cond.num.plots$variation_plot)
```

## Simulations
```{r simulation_results, echo = FALSE}
# bulk benchmark
if(dir.exists(paste(temp.dir, "/results/simulation/bulks", sep = ""))) {
	results.lists <- list()
	files <- list.files(paste(temp.dir,"/results/simulation/bulks", sep=""), full.names = T, pattern = "*.h5")
	for(i in 1:length(files)){
		results.lists[[i]] <- read_result_list(files[i])
	}
	bulks.df <- data.frame()
	for(i in 1:length(results.lists)){
		bulks.df <- rbind(bulks.df, prepare_data(results.lists[[i]], params$metric))
	}

	score.plot.sim <- evaluation_plot(bulks.df, "deconvolution quality (simulated bulks)", params$metric)
	runtime.plot.sim <- plot_runtime(bulks.df)
	scatter.plots.list.sim <- list()
	for(i in 1:length(results.lists)){
		scatter.plots.list.sim[[i]] <- create_scatterplots(results.lists[[i]])
	}
	score.width <- 2*length(unique(bulks.df$cell_type))
}
# sample benchmark
if(dir.exists(paste(temp.dir, "/results/simulation/samples", sep = ""))){
	results.lists <- list()
	files <- list.files(paste(temp.dir, "/results/simulation/samples", sep = ""), full.names = T, pattern = "*.h5")
	for(i in 1:length(files)){
		results.lists[[i]] <- read_result_list(files[i])
	}
	samples.df <- data.frame()
	for(i in 1:length(results.lists)){
		samples.df <- rbind(samples.df, prepare_data(results.lists[[i]], params$metric))
	}
	sample.plots <- create_boxplots(samples.df, metric = params$metric)
}

# gene benchmark
if(dir.exists(paste(temp.dir, "/results/simulation/genes", sep=""))){
	results.lists <- list()
	files <- list.files(paste(temp.dir, "/results/simulation/genes/", sep=""), full.names = T, pattern = "*.h5")
	for(i in 1:length(files)){
		results.lists[[i]] <- read_result_list(files[i])
	}
	genes.df <- data.frame()
	for(i in 1:length(results.lists)){
		genes.df <- rbind(genes.df, prepare_data(results.lists[[i]], params$metric))
	}
	gene.plots <- create_lineplots(genes.df, metric = params$metric, genesets, rownames(training.exprs))
}

# subtype benchmark
if(dir.exists(paste(temp.dir, "/results/simulation/subtypes", sep=""))){
	results.lists <- list()
	files <- list.files(paste(temp.dir, "/results/simulation/subtypes/", sep=""), full.names = T, pattern = "*.h5")
	for(i in 1:length(files)){
		results.lists[[i]] <- read_result_list(files[i])
	}
	subtypes.df <- data.frame()
	for(i in 1:length(results.lists)){
		subtypes.df <- rbind(subtypes.df, prepare_data(results.lists[[i]], params$metric))
	}
	score.plot.subtype <- evaluation_plot(subtypes.df, "deconvolution quality (simulated subtypes)", params$metric)
	runtime.plot.subtype <- plot_runtime(subtypes.df)
}

```

### Bulk simulations
```{r bulk_sim_scores, fig.width = score.width, fig.height = score.height}
if(exists("score.plot.sim"))
	plot(score.plot.sim)
```

```{r bulk_sim_scatter, fig.width = 18, fig.height = 5}
if(exists("scatter.plots.list.sim")){
	for(l in scatter.plots.list.sim){
		for(p in l){
			plot(p)
		}
	}
}
```

\pagebreak
### Training set size simulation
```{r sample_sim, fig.width = 16, fig.height = 9}
if(exists("sample.plots")){
	for(p in sample.plots$cell.type.plots) plot(p)
}
```

\pagebreak
### Geneset simulation
```{r geneset_sim, fig.width = 16, fig.height = 9}
if(exists("gene.plots")){
	plot(gene.plots$runtime.plot)
	for(p in gene.plots$cell.type.plots)
		plot(p)
}
```

### Subtype simulation
```{r subtype_sim, fig.width = score.width, fig.height = score.height}
if(exists("score.plot.subtype")){
  plot(score.plot.subtype)
}
if(exists("runtime.plot.subtype")){
  plot(runtime.plot.subtype)
}
```
